<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Causal Forests (Nonparametric CATE Estimation)</title>
  <script>
    if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  </script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
      color: #111827;
      background: #ffffff;
    }
    h1, h2, h3 { color: #111827; }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
    code { background-color: #f3f4f6; padding: 2px 6px; border-radius: 6px; }
    pre { background-color: #0b1020; color: #e5e7eb; padding: 16px; border-radius: 10px; overflow-x: auto; }
    pre code { background: transparent; padding: 0; }
    blockquote { border-left: 4px solid #e5e7eb; margin: 0; padding-left: 16px; color: #4b5563; }
    table { width: 100%; border-collapse: collapse; margin: 16px 0; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
    th { background: #f9fafb; }
    hr { border: none; border-top: 1px solid #e5e7eb; margin: 24px 0; }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e5e7eb;
    }
    .back-link {
      font-weight: 600;
      text-decoration: none;
    }
    .back-link:hover {
      text-decoration: underline;
    }

    .theme-toggle {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.5rem;
      padding: 8px;
      border-radius: 50%;
      transition: background 0.2s;
    }
    .theme-toggle:hover {
      background: rgba(0,0,0,0.05);
    }
    .dark .theme-toggle:hover {
      background: rgba(255,255,255,0.1);
    }

    .dark body {
      background: #0f172a;
      color: #e2e8f0;
    }
    .dark h1, .dark h2, .dark h3 { color: #f1f5f9; }
    .dark a { color: #60a5fa; }
    .dark .page-header { border-bottom-color: #334155; }
    .dark code { background-color: #1e293b; color: #e2e8f0; }
    .dark pre {
      border: 1px solid #334155;
    }
    .dark blockquote {
      border-left-color: #334155;
      color: #94a3b8;
    }
    .dark th, .dark td { border-color: #334155; }
    .dark th { background: #1e293b; }
    .dark hr { border-top-color: #334155; }

    /* Copy Button */
    pre { position: relative; }
    .copy-button {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 8px;
      font-size: 0.8rem;
      color: #94a3b8;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s, background 0.2s;
    }
    pre:hover .copy-button, .copy-button:focus {
      opacity: 1;
    }
    .copy-button:hover {
      background: rgba(255, 255, 255, 0.2);
      color: #e2e8f0;
    }

    /* Skip Link */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: #0f172a;
      color: white;
      padding: 8px 16px;
      z-index: 100;
      transition: top 0.2s;
      font-weight: 600;
      border-bottom-right-radius: 6px;
    }
    .skip-link:focus {
      top: 0;
    }

  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to content</a>

  <div class="page-header">
    <a href="../../../../../hubs/causal-inference-index.html" class="back-link">‚Üê Back to Causal Inference</a>
    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle Dark Mode">üåô</button>
  </div>
  <main id="main-content">

<h1 id="topic-causal-forests-nonparametric-cate-estimation">Topic: Causal Forests (Nonparametric CATE Estimation)</h1>
<h2 id="1-formal-definition-what-is-it-and-how-can-we-use-it">1) Formal definition (what is it, and how can we use it?)</h2>
<p>Causal Forests are a machine learning method, specifically an adaptation of Random Forests, used for <strong>nonparametric estimation of the Conditional Average Treatment Effect (CATE)</strong>. In simpler terms, they allow us to estimate how the effect of a treatment (or intervention) varies across different subgroups of a population based on observed characteristics (covariates).</p>
<ul>
<li>
<p><strong>What it is:</strong>  A causal forest is an ensemble of causal trees. Each tree is constructed by:</p>
<ul>
<li><strong>Honest Splitting:</strong> The data is split into two independent subsets: one used to determine the splitting variable and split point (splitting set), and the other used to estimate the treatment effect within each resulting node (estimation set). This is crucial to avoid overfitting to spurious correlations. This is also called sample splitting.</li>
<li><strong>Centering:</strong> Outcomes and treatment indicators are often centered by subtracting their conditional expectations given covariates. This helps to remove bias.  The conditional expectations can be estimated using standard regression techniques.</li>
<li><strong>Treatment Effect Estimation:</strong>  Within each terminal node (leaf) of the tree, the CATE is estimated as the difference in average outcomes between the treated and control groups within that node.</li>
</ul>
</li>
<li>
<p><strong>How we can use it:</strong></p>
<ul>
<li><strong>Personalized Treatment Recommendations:</strong> Identify individuals or subgroups who are most likely to benefit from a particular treatment. For example, determining which patients are most likely to respond positively to a new drug based on their medical history and demographics.</li>
<li><strong>Policy Optimization:</strong>  Design policies that target specific interventions to the most receptive segments of the population.  For example, allocating resources to job training programs based on individual characteristics that predict success.</li>
<li><strong>Understanding Heterogeneous Treatment Effects:</strong>  Explore how the treatment effect varies across different values of covariates, providing insights into the underlying mechanisms driving the observed effects.</li>
<li><strong>Counterfactual Prediction:</strong> By understanding the conditional treatment effects, we can make predictions about what would have happened if an individual had received a different treatment.</li>
</ul>
</li>
</ul>
<p>The key advantage of causal forests compared to simpler methods (like linear regression with interaction terms) is their ability to flexibly model complex, nonlinear relationships between covariates and treatment effects <em>without</em> strong parametric assumptions.  This makes them more robust to model misspecification.  They also have theoretical guarantees for consistency and asymptotic normality under certain regularity conditions.</p>
<h2 id="2-application-scenario">2) Application scenario</h2>
<p>Imagine a company wants to run a marketing campaign to promote a new product.  They have data on their existing customers, including demographics (age, income, location), past purchase history, and web browsing behavior. The company wants to determine which customers are most likely to be persuaded to purchase the new product by receiving a promotional email.</p>
<p>In this scenario:</p>
<ul>
<li><strong>Treatment:</strong> Receiving the promotional email (1 = received, 0 = did not receive).</li>
<li><strong>Outcome:</strong> Whether the customer purchased the product within a certain time frame (1 = purchased, 0 = did not purchase).</li>
<li><strong>Covariates:</strong> Age, income, location, past purchase history, web browsing behavior.</li>
</ul>
<p>The company can use a causal forest to estimate the CATE ‚Äì the effect of receiving the promotional email on the probability of purchasing the product, <em>conditional on</em> the customer's characteristics. The causal forest will learn to identify subgroups of customers who are particularly responsive to the email. For example, it might find that younger customers with a history of purchasing similar products are much more likely to buy the new product after receiving the email than older customers with no such history.</p>
<p>Based on the CATE estimates from the causal forest, the company can then target their marketing efforts more effectively, sending the promotional email only to the customers who are predicted to have the largest positive response. This can lead to a higher return on investment for the marketing campaign.</p>
<h2 id="3-python-method-if-possible">3) Python method (if possible)</h2>
<p>Several Python packages implement causal forests. One popular option is <code>econml</code> (Econometrics and Machine Learning). Here's a basic example:</p>
<pre class="codehilite"><code class="language-python">import numpy as np
import pandas as pd
from sklearn.ensemble import RandomForestRegressor
from econml.ensemble import CausalForestRegressor

# Generate some synthetic data (replace with your actual data)
np.random.seed(42)
n = 1000
X = np.random.rand(n, 5)  # Covariates
T = np.random.binomial(1, 0.5, n)  # Treatment (0 or 1)
Y = 2 * X[:, 0] + 1 * X[:, 1] + 3 * T + 2 * T * X[:, 2] + np.random.normal(0, 1, n) # Outcome

# Fit a Causal Forest
forest = CausalForestRegressor(n_estimators=100,
                                min_samples_leaf=10,
                                max_depth=None,
                                random_state=42)
forest.fit(Y, T, X=X)

# Estimate the CATE for new data points
X_new = np.random.rand(10, 5)  # New covariate values
cate_estimates = forest.effect(X_new)

print(&quot;Estimated CATEs:&quot;, cate_estimates)

# Get the CATE estimates for the training data
cate_train = forest.effect(X)

#Get the point estimates and the standard errors of the treatment effect
point_est = forest.effect(X)
point_est_interval = forest.effect_interval(X, alpha=0.05)

print(&quot;Point estimates:&quot;, point_est)
print(&quot;Point estimates interval:&quot;, point_est_interval)
</code></pre>

<p><strong>Explanation:</strong></p>
<ol>
<li><strong>Import necessary libraries:</strong> <code>numpy</code>, <code>pandas</code>, <code>sklearn.ensemble.RandomForestRegressor</code> (for propensity score estimation if needed), and <code>econml.ensemble.CausalForestRegressor</code>.</li>
<li><strong>Generate Synthetic Data:</strong> Replace this section with your own data loading and preprocessing steps. The example generates random covariates (<code>X</code>), treatment assignments (<code>T</code>), and outcomes (<code>Y</code>) with a specified treatment effect. Importantly, the outcome Y includes an interaction term between treatment and X[:,2] to simulate heterogeneous treatment effects.</li>
<li><strong>Create and fit the Causal Forest:</strong><ul>
<li><code>CausalForestRegressor</code> is instantiated with parameters like <code>n_estimators</code> (number of trees), <code>min_samples_leaf</code> (minimum samples in a leaf node), <code>max_depth</code> (maximum depth of the trees) and <code>random_state</code> for reproducibility.</li>
<li><code>forest.fit(Y, T, X=X)</code> trains the causal forest on the outcome <code>Y</code>, treatment <code>T</code>, and covariates <code>X</code>.</li>
</ul>
</li>
<li><strong>Estimate the CATE:</strong><ul>
<li><code>forest.effect(X_new)</code> estimates the CATE for new data points <code>X_new</code>.  It returns an array of CATE estimates, one for each row in <code>X_new</code>.</li>
<li><code>forest.effect(X)</code> estimates the CATE for the original training data.</li>
<li><code>forest.effect_interval(X, alpha=0.05)</code> estimates the CATE and also provides confidence intervals. The alpha parameter controls the width of the interval (e.g. 0.05 for a 95% confidence interval).</li>
</ul>
</li>
</ol>
<p><strong>Important Notes:</strong></p>
<ul>
<li><code>econml</code> relies on honest splitting. The <code>fit</code> method implicitly does this.</li>
<li>Pre-process data and ensure it is properly formatted.</li>
<li>Tune hyperparameters (e.g., <code>n_estimators</code>, <code>min_samples_leaf</code>, <code>max_depth</code>) using cross-validation to optimize performance on your specific dataset.  Consider using methods for tuning hyperparameters of Causal Forests, as standard methods can be ineffective.</li>
<li>Consider using other CATE estimation methods in conjunction with Causal Forests (e.g., T-learners, S-learners) and comparing the results for robustness.</li>
<li>Ensure that the overlap assumption (also known as positivity) is satisfied; i.e. the probability of receiving treatment and control is greater than 0 for each individual, given the covariates. This can be examined after fitting the CATE.</li>
</ul>
<h2 id="4-follow-up-question">4) Follow-up question</h2>
<p>How does the "honesty" of splitting in causal forests relate to the bias-variance tradeoff, and why is it so crucial for reliable CATE estimation? Also, how does honesty help with inference (i.e., accurate standard errors) compared to non-honest approaches?</p>
    </main>
<script>
    const btn = document.getElementById('theme-toggle');
    const html = document.documentElement;
    
    function updateIcon() {
      btn.textContent = html.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
    }
    
    // Set initial icon
    updateIcon();

    btn.addEventListener('click', () => {
      if (html.classList.contains('dark')) {
        html.classList.remove('dark');
        localStorage.theme = 'light';
      } else {
        html.classList.add('dark');
        localStorage.theme = 'dark';
      }
      updateIcon();
    });

    // Copy Code Functionality
    document.querySelectorAll('pre').forEach(pre => {
      const button = document.createElement('button');
      button.className = 'copy-button';
      button.textContent = 'Copy';
      button.setAttribute('aria-label', 'Copy code to clipboard');

      pre.appendChild(button);

      button.addEventListener('click', async () => {
        const code = pre.querySelector('code');
        if (!code) return;

        try {
          await navigator.clipboard.writeText(code.innerText);
          button.textContent = 'Copied!';
          setTimeout(() => {
            button.textContent = 'Copy';
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
          button.textContent = 'Error';
        }
      });
    });
  </script>
</body>
</html>
